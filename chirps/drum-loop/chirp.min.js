var CHIRP={frequencies:[16.35,17.32,18.35,19.45,20.6,21.83,23.12,24.5,25.96,27.5,29.14,30.87],instruments:{},extend:function(){for(var t=1;t<arguments.length;t++)for(var i in arguments[t])arguments[0][i]=arguments[t][i];return arguments[0]}};CHIRP.Engine=function(){this.setTempo(130),this.tracks=[],this.instruments=[],this.position=0,this.length=0,this.playing=!1,this.range=0,this.shift=0,this.volume=.5,this.supertime=0},CHIRP.Engine.prototype={setTempo:function(t){this.bpm=t,this.bps=this.bpm/60,this.beatDuration=60/this.bpm},start:function(){var t=this,i=window.AudioContext||window.webkitAudioContext;return i?i?(this.context=new i,this.output=this.context.createGainNode(),this.output.connect(this.context.destination),this.output.gain.value=this.volume,this.lastTick=Date.now(),this._step=this.step.bind(this),requestAnimationFrame(this._step),this.length=4,document.addEventListener("webkitvisibilitychange",function(){document.webkitHidden?(t.output.gain.value=0,t.playing&&(t.playing=!1,t.paused=!0)):(t.output.gain.value=t.volume,t.paused&&(t.playing=!0,t.paused=!1))},!1),!0):!1:!1},frequency:function(t,i){if("undefined"==typeof i){var i=0|t/CHIRP.frequencies.length,s=t%CHIRP.frequencies.length;return CHIRP.frequencies[s]*Math.pow(2,i)}return CHIRP.frequencies[t]*Math.pow(2,i)},play:function(){this.playing=!0},pause:function(){this.playing=!1;for(var t=0;t<this.tracks.length;t++)this.tracks[t].instrument.stop(!0)},step:function(){requestAnimationFrame(this._step);var t=Date.now(),i=(t-this.lastTick)/1e3;if(this.lastTick=t,!(i>.05)){for(var s=0;s<this.tracks.length;s++){var n=this.tracks[s];n.step(i),n.instrument&&n.instrument.step&&n.instrument.step(i)}this.playing&&(this.position+=this.bps*i),(this.position>=this.length||this.range&&this.position>this.range[0]+this.range[1])&&this.restart(),this.supertime+=i,this.superposition=this.playing?this.position:this.supertime/this.beatDuration}},seek:function(t){this.nextIndex=0,this.position=t;for(var i=0;i<this.tracks.length;i++)this.tracks[i].seek(t)},restart:function(){this.onrestart&&this.onrestart(),this.seek(this.range?this.range[0]:0,!0)}},CHIRP.Track=function(t,i){this.engine=t,this.notes=[],this.clips=[],this.queue=[],this.instrument=i.instrument,this.index=i.index,this.seek(0)},CHIRP.Track.prototype={step:function(t){if(this.engine.playing){for(var i=this.lastIndex;i<this.notes.length;i++){var s=this.notes[i];s.start>this.position||(s.played?!s.finished&&s.start+s.duration<this.position&&(s.finished=!0,this.instrument.stop(s.key),s.start+s.duration<=this.maxPosition):(s.played=!0,this.instrument.play(s),s.start+s.duration>this.maxPosition&&(this.maxPosition=s.start+s.duration)))}this.position+=this.engine.bps*t}},seek:function(t,i){this.lastIndex=0,this.position=t,this.instrument&&this.instrument.stop(!i),this.maxPosition=0;for(var s=0;s<this.notes.length;s++){var n=this.notes[s];n.played=n.start<this.position,n.finished=n.start+n.duration<this.position}}},CHIRP.Engine.prototype.open=function(t){this.tracks=[],this.meta=t.meta||{};for(var i=0;i<t.tracks.length;i++){var s=t.tracks[i],n=new CHIRP.instruments[s.instrumentPlugin](this,s.instrumentData),e=new CHIRP.Track(this,{index:i,instrument:n});n.pluginName=s.instrumentPlugin,e.notes=s.notes,e.clips=s.clips,this.tracks.push(e)}this.length=t.length||16,this.setTempo(t.bpm),this.seek(0)};